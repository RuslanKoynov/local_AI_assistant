<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–æ–∫–∞–ª—å–Ω—ã–π AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã -->
    <style>
        /* CSS —Å—Ç–∏–ª–∏ */
        body {
            font-family: Arial, Helvetica, sans-serif;
            text-align: center;
        }
        #container {
            width: 350px;
            margin: 20px auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 15px;
        }
        h1 {
            color: #4a6fa5;
            font-size: 18px;
            margin-bottom: 10px;
        }
        #messages {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
        }
        .user-message {
            background: #e3f2fd;
            float: right;
            clear: both;
        }
        .bot-message {
            background: #fff;
            float: left;
            clear: both;
        }
        #input-container {
            display: flex;
            align-items: center;
        }
        input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
        }
        button {
            background: #4a6fa5;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            cursor: pointer;
        }
        #file-info {
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
        #file-button {
            background: transparent;
            border: none;
            cursor: pointer;
        }
        #file-button::before {
            content: "üìÅ";
            font-size: 18px;
        }
    </style>
</head>
<body>
    <script type="module">
    import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@huggingface/transformers";
    //import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@xenova/transformers";
    env.allowLocalModels = false;
    const status = document.getElementById("status");
    status.textContent = "Loading model...";
    const detector = await pipeline('text-generation', 'onnx-community/N1-ONNX');
    status.textContent = "Ready";
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —ç–ª–µ–º–µ–Ω—Ç—ã DOM
    const messagesEl = document.getElementById('messages');
    const userInputEl = document.getElementById('user-input');
    const fileButtonEl = document.getElementById('file-button');
    const sendBtnEl = document.getElementById('send-button');
    const fileInputEl = document.getElementById('file-input');
    const fileInfoEl = document.getElementById('file-info');
//    const { pipeline } = transformers;

    // –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
    const STORAGE_KEY = 'ai_assistant_chat_history';
    let chatHistory = [];

    // –¢–µ–∫—É—â–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    let currentFile = null;

    // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
    function restoreChatHistory() {
        const storedMessages = localStorage.getItem(STORAGE_KEY);
        if (storedMessages) {
            chatHistory = JSON.parse(storedMessages);
            renderChatHistory(chatHistory);
        }
    }

    // –†–µ–Ω–¥–µ—Ä–∏—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –≤ —ç–ª–µ–º–µ–Ω—Ç–µ messages
    function renderChatHistory(history) {
        history.forEach(message => {
            appendMessage(message.sender, message.text);
        });
    }


    // –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
    async function sendMessage() {
        const userMsg = userInputEl.value.trim();
        if (!userMsg && !currentFile) return;

        // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        appendMessage('user', userMsg);
        chatHistory.push({ sender: 'user', text: userMsg });

        // –ü–æ–ª—É—á–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ —Ñ–∞–π–ª –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        let fileContent = '';
        if (currentFile) {
            fileContent = await readFileAsText(currentFile);
            appendMessage('user', `[–§–∞–π–ª]: ${currentFile.name}\n${fileContent}`);
            chatHistory.push({ sender: 'user', text: `[–§–∞–π–ª]: ${currentFile.name}\n${fileContent}` });
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –ø–æ–º–æ—â–Ω–∏–∫–∞
        try {
            const fullPrompt = `${userMsg}${fileContent ? '\n' + fileContent : ''}`;
            const generatedResponse = await generateResponse(fullPrompt);
            appendMessage('bot', generatedResponse);
            chatHistory.push({ sender: 'bot', text: generatedResponse });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
            saveChatHistory();
        } catch (err) {
            console.error(err);
            appendMessage('bot', '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–∑–∂–µ...');
        }

        // –û—á–∏—â–∞–µ–º –≤—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–µ –∏ —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª
        userInputEl.value = '';
        clearCurrentFile();
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç AI –º–æ–¥–µ–ª–∏
    async function generateResponse(input) {
        const response = await detector(input, {max_new_tokens: 500, temperature: 0.7});
        return response[0].generated_text;
    }

    // –ß–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª –∫–∞–∫ —Ç–µ–∫—Å—Ç
    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = event => resolve(event.target.result);
            reader.onerror = error => reject(error);
            reader.readAsText(file);
        });
    }

    // –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
    function openFileDialog() {
        fileInputEl.click();
    }

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    function handleFileUpload(event) {
        const file = event.target.files[0];
        console.log(file);
        if (file) {
            currentFile = file;
            fileInfoEl.textContent = `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name}`;
        }
    }

    // –£–¥–∞–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª
    function clearCurrentFile() {
        currentFile = null;
        fileInfoEl.textContent = '';
    }

    // –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ UI
    function appendMessage(sender, text) {
        const div = document.createElement('div');
        div.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
        div.textContent = text;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –≤ Local Storage
    function saveChatHistory() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
    }

    sendBtnEl.addEventListener('click', sendMessage);
        userInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

    fileButtonEl.addEventListener('click', () => {
        fileInputEl.click();
    });

    fileInputEl.addEventListener('change', handleFileUpload);

    restoreChatHistory();

</script>
<div id="container">
    <p id="status"></p>
    <h1>AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h1>
    <div id="messages"></div>
    <div id="input-container">
        <input type="text" id="user-input" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∫–æ–¥..." />
        <button id="send-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <div id="file-info"></div>
    <input type="file" id="file-input" accept=".js,.py,.java,.c,.cpp,.cs,.php,.html,.css,.txt" style="display:none;"/>
    <button id="file-button"></button>
</div>

</body>
</html>
